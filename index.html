<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>朋友圈宣发图合成</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            user-select: none;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 1000px;
            width: 100%;
        }

        h2 { color: #333; margin-bottom: 10px; }
        p { color: #666; font-size: 14px; margin-bottom: 20px; }

        /* 顶部上传按钮区域 */
        .top-bar {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
            flex-wrap: wrap;
        }

        input[type="file"] { display: none; }

        .btn {
            border: 2px solid #007bff;
            color: #007bff;
            background-color: white;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn:hover { background-color: #007bff; color: white; }

        .btn-secondary { border-color: #6c757d; color: #6c757d; }
        .btn-secondary:hover { background-color: #6c757d; color: white; }
        
        .btn-purple { border-color: #6f42c1; color: #6f42c1; }
        .btn-purple:hover { background-color: #6f42c1; color: white; }

        /* --- 核心布局：左右结构 --- */
        .editor-wrapper {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        /* --- 左侧：控制面板 --- */
        .sidebar {
            width: 280px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            text-align: left;
        }

        .control-group {
            margin-bottom: 5px;
            border-bottom: 1px dashed #e0e0e0;
            padding-bottom: 10px;
        }
        .control-group:last-child { border-bottom: none; }
        
        .control-group label {
            display: block;
            font-size: 14px;
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
        }

        .slider-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .slider-row input { flex: 1; }
        .slider-value { font-size: 12px; color: #777; width: 35px; text-align: right;}

        .tip { font-size: 12px; color: #999; line-height: 1.5; background: #fff; padding: 10px; border-radius: 4px; border: 1px dashed #ccc;}

        /* --- 右侧：画布区域 --- */
        #canvas-container {
            border: 1px solid #ccc;
            background-color: #e0e0e0;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 4px;
        }

        canvas {
            width: 100%;           
            max-width: 350px;      
            height: auto;          
            aspect-ratio: 2/3;
            background-color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: block;
            /* 默认手型 */
            cursor: grab; 
        }
        canvas:active { cursor: grabbing; }

        #download-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-size: 15px;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s;
            margin-top: 10px;
        }
        #download-btn:hover { background-color: #218838; }

    </style>
</head>
<body>

    <div class="container">
        <h2>朋友圈宣发图合成</h2>
        <p> 江苏省域-市场营销部-郭昊灵</p>

        <!-- 顶部：上传按钮 -->
        <div class="top-bar">
            <label class="btn">
                ① 上传照片
                <input type="file" id="bg-input" accept="image/*">
            </label>

            <label class="btn btn-secondary">
                ② 边框固定
                <input type="file" id="overlay-input" accept="image/*">
            </label>

            <label class="btn btn-purple">
                ③ 可选元素
                <input type="file" id="overlay2-input" accept="image/*">
            </label>
        </div>

        <!-- 中间：左右布局 -->
        <div class="editor-wrapper">
            
            <!-- 左侧：控制栏 -->
            <div id="sidebar-controls" class="sidebar" style="display:none;">
                <div class="control-group">
                    <label>照片缩放</label>
                    <div class="slider-row">
                        <input type="range" id="bg-scale-slider" min="10" max="500" value="100">
                        <span id="bg-scale-val" class="slider-value">100%</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>边框固定</label>
                    <div class="slider-row">
                        <input type="range" id="overlay-scale-slider" min="5" max="100" value="100">
                        <span id="overlay-scale-val" class="slider-value">100%</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>可选元素</label>
                    <div class="slider-row">
                        <input type="range" id="overlay2-scale-slider" min="5" max="100" value="30">
                        <span id="overlay2-scale-val" class="slider-value">30%</span>
                    </div>
                </div>

                <div class="tip">
                    <b>操作提示：</b><br>
                    • <b>照片</b>：鼠标拖拽移动，滚轮缩放<br>
                    • <b>可选元素</b>：直接鼠标拖拽移动，滚轮缩放<br>
                    • 边框固定在下方
                </div>

                <button id="download-btn" onclick="downloadCanvas()">下载图片</button>
            </div>

            <!-- 右侧：画布 -->
            <div id="canvas-container">
                <canvas id="myCanvas"></canvas>
            </div>

        </div>
    </div>

    <script>
        const canvas = document.getElementById('myCanvas');
        const ctx = canvas.getContext('2d');
        
        // Inputs
        const bgInput = document.getElementById('bg-input');
        const overlayInput = document.getElementById('overlay-input');
        const overlay2Input = document.getElementById('overlay2-input');
        
        const sidebar = document.getElementById('sidebar-controls');
        
        // Sliders
        const bgScaleSlider = document.getElementById('bg-scale-slider');
        const overlayScaleSlider = document.getElementById('overlay-scale-slider');
        const overlay2ScaleSlider = document.getElementById('overlay2-scale-slider');

        // Values display
        const bgScaleVal = document.getElementById('bg-scale-val');
        const overlayScaleVal = document.getElementById('overlay-scale-val');
        const overlay2ScaleVal = document.getElementById('overlay2-scale-val');

        // Canvas Resolution
        const FIXED_WIDTH = 2000;
        const FIXED_HEIGHT = 3000;
        canvas.width = FIXED_WIDTH;
        canvas.height = FIXED_HEIGHT;

        // Image Objects
        let bgImg = new Image();
        let overlayImg = new Image();
        let overlay2Img = new Image();

        // Load States
        let bgLoaded = false;
        let overlayLoaded = false;
        let overlay2Loaded = false;

        // Transform States
        // 底图状态
        let bgState = { x: 0, y: 0, scale: 1, baseScale: 1 };
        // 叠加图2状态 (x,y 是左上角坐标，scale是相对于画布宽度的比例)
        let ov2State = { x: 0, y: 0, scale: 0.3, width: 0, height: 0 };

        // Interaction States
        let isDragging = false;
        let dragTarget = null; // 'bg' or 'overlay2'
        let lastMouseX = 0;
        let lastMouseY = 0;

        function drawInit() {
            ctx.fillStyle = "#f8f9fa";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = "#ddd";
            ctx.lineWidth = 20;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = "#aaa";
            ctx.font = "bold 80px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText("预览区域", canvas.width/2, canvas.height/2);
        }
        drawInit();

        // --- 1. Background Logic ---
        bgInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                bgImg.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        bgImg.onload = () => {
            bgLoaded = true;
            sidebar.style.display = 'flex';
            
            const canvasRatio = canvas.width / canvas.height;
            const imgRatio = bgImg.width / bgImg.height;

            if (imgRatio > canvasRatio) {
                bgState.baseScale = canvas.height / bgImg.height;
            } else {
                bgState.baseScale = canvas.width / bgImg.width;
            }

            bgState.scale = bgState.baseScale;
            bgState.x = (canvas.width - bgImg.width * bgState.scale) / 2;
            bgState.y = (canvas.height - bgImg.height * bgState.scale) / 2;

            bgScaleSlider.value = 100;
            bgScaleVal.innerText = "100%";
            draw();
        };

        // --- 2. Overlay 1 Logic (Fixed Bottom Right) ---
        overlayInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                overlayImg.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        overlayImg.onload = () => {
            overlayLoaded = true;
            sidebar.style.display = 'flex';
            draw();
        };

        // --- 3. Overlay 2 Logic (Movable) ---
        overlay2Input.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                overlay2Img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        overlay2Img.onload = () => {
            overlay2Loaded = true;
            sidebar.style.display = 'flex';
            
            // 初始化 Overlay2 尺寸和位置
            ov2State.scale = 0.3; // 默认30%
            updateOverlay2Dimensions();
            
            // 默认放在左上角稍微偏移一点
            ov2State.x = 50;
            ov2State.y = 50;

            overlay2ScaleSlider.value = 30;
            overlay2ScaleVal.innerText = "30%";

            draw();
        };

        function updateOverlay2Dimensions() {
            if(!overlay2Loaded) return;
            ov2State.width = canvas.width * ov2State.scale;
            const ratio = overlay2Img.height / overlay2Img.width;
            ov2State.height = ov2State.width * ratio;
        }

        // --- Sliders Events ---
        bgScaleSlider.addEventListener('input', () => {
            if (!bgLoaded) return;
            const sliderVal = parseInt(bgScaleSlider.value);
            bgScaleVal.innerText = sliderVal + "%";
            
            const newScale = bgState.baseScale * (sliderVal / 100);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            const offsetX = centerX - bgState.x;
            const offsetY = centerY - bgState.y;
            const scaleRatio = newScale / bgState.scale;
            
            bgState.x = centerX - (offsetX * scaleRatio);
            bgState.y = centerY - (offsetY * scaleRatio);
            bgState.scale = newScale;
            draw();
        });

        overlayScaleSlider.addEventListener('input', () => {
            overlayScaleVal.innerText = overlayScaleSlider.value + "%";
            draw();
        });

        overlay2ScaleSlider.addEventListener('input', () => {
            if (!overlay2Loaded) return;
            const val = parseInt(overlay2ScaleSlider.value);
            overlay2ScaleVal.innerText = val + "%";
            
            // 保持中心点缩放逻辑
            const oldW = ov2State.width;
            const oldH = ov2State.height;
            const centerX = ov2State.x + oldW / 2;
            const centerY = ov2State.y + oldH / 2;

            ov2State.scale = val / 100;
            updateOverlay2Dimensions();

            ov2State.x = centerX - ov2State.width / 2;
            ov2State.y = centerY - ov2State.height / 2;

            draw();
        });

        // --- 坐标转换辅助函数 ---
        function getCanvasCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        function isMouseOnOverlay2(mx, my) {
            if (!overlay2Loaded) return false;
            return mx >= ov2State.x && mx <= ov2State.x + ov2State.width &&
                   my >= ov2State.y && my <= ov2State.y + ov2State.height;
        }

        // --- Mouse Events (Smart Interaction) ---
        
        canvas.addEventListener('mousedown', (e) => {
            if (!bgLoaded) return;
            
            const pos = getCanvasCoordinates(e);
            
            // 判断是否点击了 Overlay2 (优先级高于背景)
            if (isMouseOnOverlay2(pos.x, pos.y)) {
                dragTarget = 'overlay2';
                // 视觉反馈
                canvas.style.cursor = 'move';
            } else {
                dragTarget = 'bg';
                canvas.style.cursor = 'grabbing';
            }

            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
        });

        window.addEventListener('mouseup', () => {
            isDragging = false;
            dragTarget = null;
            canvas.style.cursor = 'grab'; // 恢复默认
        });

        canvas.addEventListener('mousemove', (e) => {
            // 悬停效果：如果没在拖拽，检测鼠标位置改变光标
            if (!isDragging && overlay2Loaded) {
                const pos = getCanvasCoordinates(e);
                if (isMouseOnOverlay2(pos.x, pos.y)) {
                    canvas.style.cursor = 'move';
                } else {
                    canvas.style.cursor = 'grab';
                }
            }

            if (!isDragging || !bgLoaded) return;

            const deltaX = e.clientX - lastMouseX;
            const deltaY = e.clientY - lastMouseY;

            const displayWidth = canvas.clientWidth; 
            const scaleFactor = canvas.width / displayWidth; 
            const moveX = deltaX * scaleFactor;
            const moveY = deltaY * scaleFactor;

            if (dragTarget === 'overlay2') {
                ov2State.x += moveX;
                ov2State.y += moveY;
            } else if (dragTarget === 'bg') {
                bgState.x += moveX;
                bgState.y += moveY;
            }

            lastMouseX = e.clientX;
            lastMouseY = e.clientY;

            draw();
        });

        canvas.addEventListener('wheel', (e) => {
            if (!bgLoaded) return;
            e.preventDefault();

            const pos = getCanvasCoordinates(e);
            const zoomIntensity = 0.1;
            const wheel = e.deltaY < 0 ? 1 : -1;
            const zoomFactor = Math.exp(wheel * zoomIntensity);

            // 判定滚轮是在 Overlay2 上还是在背景上
            if (isMouseOnOverlay2(pos.x, pos.y)) {
                // --- 缩放 Overlay 2 ---
                let newScale = ov2State.scale * zoomFactor;
                if (newScale < 0.05) newScale = 0.05;
                if (newScale > 1.0) newScale = 1.0;

                // 以鼠标为中心缩放 (简化版：以图片中心缩放体验更好)
                const oldW = ov2State.width;
                const oldH = ov2State.height;
                const centerX = ov2State.x + oldW / 2;
                const centerY = ov2State.y + oldH / 2;

                ov2State.scale = newScale;
                updateOverlay2Dimensions();

                ov2State.x = centerX - ov2State.width / 2;
                ov2State.y = centerY - ov2State.height / 2;

                // 同步滑块
                const sliderVal = Math.round(ov2State.scale * 100);
                overlay2ScaleSlider.value = sliderVal;
                overlay2ScaleVal.innerText = sliderVal + "%";

            } else {
                // --- 缩放 背景 ---
                let newScale = bgState.scale * zoomFactor;
                const minScale = bgState.baseScale * 0.1;
                const maxScale = bgState.baseScale * 5.0;
                
                if (newScale < minScale) newScale = minScale;
                if (newScale > maxScale) newScale = maxScale;

                // 以鼠标位置为中心缩放背景
                const mouseX = pos.x;
                const mouseY = pos.y;

                bgState.x = mouseX - (mouseX - bgState.x) * (newScale / bgState.scale);
                bgState.y = mouseY - (mouseY - bgState.y) * (newScale / bgState.scale);
                bgState.scale = newScale;

                const sliderVal = Math.round((bgState.scale / bgState.baseScale) * 100);
                bgScaleSlider.value = sliderVal;
                bgScaleVal.innerText = sliderVal + "%";
            }

            draw();
        }, { passive: false });

        // --- Main Draw Function ---
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 1. Draw Background
            if (bgLoaded) {
                const w = bgImg.width * bgState.scale;
                const h = bgImg.height * bgState.scale;
                ctx.drawImage(bgImg, bgState.x, bgState.y, w, h);
            } else {
                drawInit();
                return;
            }

            // 2. Draw Overlay 1 (Bottom Right)
            if (overlayLoaded) {
                const scale = overlayScaleSlider.value / 100;
                const newWidth = canvas.width * scale;
                const ratio = overlayImg.height / overlayImg.width;
                const newHeight = newWidth * ratio;

                const x = canvas.width - newWidth; 
                const y = canvas.height - newHeight;

                ctx.drawImage(overlayImg, x, y, newWidth, newHeight);
            }

            // 3. Draw Overlay 2 (Movable)
            if (overlay2Loaded) {
                // 绘制边框提示选中（可选，这里为了美观暂不画边框，只画图）
                ctx.drawImage(overlay2Img, ov2State.x, ov2State.y, ov2State.width, ov2State.height);
            }
        }

        function downloadCanvas() {
            if (!bgLoaded) { alert("请先上传底图"); return; }
            const imageUrl = canvas.toDataURL('image/jpeg', 0.92);
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = `宣发图-${Date.now()}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
